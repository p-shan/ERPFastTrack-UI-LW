"use strict";$(document).ready(function(){loadProjects()});var jobs={state:{},setMapping:function(e,t,a,s,o,n,i){var r={ExternalFlag:!1,LookupFlag:!1,Value:"",LookupId:"",LookupName:""},l=-1;switch(isAvail(jobs.state.mapping)?(l=jobs.state.mapping.findIndex(e=>e.Key===s))<0?(jobs.state.mapping.push({Key:s,Value:r}),l=jobs.state.mapping.findIndex(e=>e.Key===s)):r=jobs.state.mapping[l].Value:(jobs.state.mapping=[],jobs.state.mapping.push({Key:s,Value:r}),l=jobs.state.mapping.findIndex(e=>e.Key===s)),t){case"SFFIELD":a?jobs.state.mapping[l].Value={ExternalFlag:!1,LookupFlag:!1,Value:o,LookupId:"",LookupName:""}:jobs.state.mapping.splice(l,1);break;case"EXTID":jobs.state.mapping[l].Value.ExternalFlag=!!a;break;case"LOOKUP":a?(jobs.state.mapping[l].Value.LookupFlag=!0,jobs.state.mapping[l].Value.LookupId=n,jobs.state.mapping[l].Value.LookupName=i):(jobs.state.mapping[l].Value.LookupFlag=!1,jobs.state.mapping[l].Value.LookupId="",jobs.state.mapping[l].Value.LookupName="")}},load:function(){},genSections:{projects:{title:"Projects",identifier:"Projects",postLoad:function(e){var t={title:function(e){return e.name},template:function(e){$(e.element).data("destinationTypeId");var t="";switch($(e.element).data("projectTypeId")){case 1:t="Database ➡️ Salesforce";return $(`<div>
                                      <h4 class="mb-1 d-flex align-items-center">                    
                                        <strong>${e.text}</strong> <small class="text-sm"> <span class="ms-2 badge bg-label-dark">${t}</span></small>
                                      </h4>
                                    </div>
                                    <small class="text-sm">
                                        <div class="mb-0 alert alert-primary d-flex align-items-center" role="alert">
                                        <span class="alert-icon text-primary me-2 p-2">
                                            <i class="fa-solid fa-database fa-fw"></i>
                                        </span>${$(e.element).data("sourceConnString")}
                                        </div>
                                        <div class="mt-1 mb-0 alert alert-info d-flex align-items-center" role="alert">
                                        <span class="alert-icon text-info me-2 p-2">
                                            <i class="fa-brands fa-salesforce fa-fw"></i>
                                        </span>${$(e.element).data("destConnUrl")}
                                        </div>
                                    </small>`);case 2:$(e.element).data("destinationTypeId");return t="File Source ➡️ Salesforce",$(`<div>
                                      <h4 class="mb-1 d-flex align-items-center">                    
                                        <strong>${e.text}</strong> <small class="text-sm"> <span class="ms-2 badge bg-label-dark">${t}</span></small>
                                      </h4>
                                    </div>
                                    <small class="text-sm">
                                        <div class="mb-0 alert alert-warning d-flex align-items-center" role="alert">
                                        <span class="alert-icon text-warning me-2 p-2">
                                            <i class="fa-solid fa-file fa-fw"></i>
                                        </span>${$(e.element).data("sourceConnString")}
                                        </div>
                                        <div class="mt-1 mb-0 alert alert-info d-flex align-items-center" role="alert">
                                        <span class="alert-icon text-info me-2 p-2">
                                            <i class="fa-brands fa-salesforce fa-fw"></i>
                                        </span>${$(e.element).data("destConnUrl")}
                                        </div>
                                    </small>`)}},attributes:[{key:"sourceConnString",value:"sourceConnString"},{key:"destConnUrl",value:"destConnUrl"},{key:"projectTypeId",value:"projectTypeId"},{key:"destinationTypeId",value:"destinationTypeId"}]};parameterCtrl.selectAjax({uri:"/api/operations/project",title:"Project",fields:[{selIdentifier:"#selProjects",resKey:"id",resValue:"name",parentIdentifier:"#hbsInnersectionProjects .card-body",title:t.title,attributes:t.attributes,template:t.template}]},function(e){$("#btnClearJobs").click(function(){parameterCtrl.unloadSectionWithCallbacks(jobs.genSections.jobs),parameterCtrl.unloadSectionWithCallbacks(jobs.genSections.upsertJobs),parameterCtrl.unloadSectionWithCallbacks(jobs.genSections.mapping),$("#selProjects").prop("disabled",!1).trigger("change"),$("#selProjects").val("").trigger("change"),$("#btnLoadJobs").prop("disabled",!1)}),$("#btnLoadJobs").click(function(){0<$("#selProjects").val().length?$.ajax({url:"/api/operations/project/"+$("#selProjects").val(),type:"GET",contentType:"application/json",success:function(e){jobs.state.selectedProject=e,parameterCtrl.unloadSectionWithCallbacks(jobs.genSections.jobs),parameterCtrl.unloadSectionWithCallbacks(jobs.genSections.upsertJobs),parameterCtrl.unloadSectionWithCallbacks(jobs.genSections.mapping),loadJobs(),$("#selProjects").prop("disabled",!0).trigger("change"),$("#btnLoadJobs").prop("disabled",!0)}}):Swal.fire({title:"Notification",text:"Please select the project to proceed.",icon:"info",customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1})})})},postUnload:function(e){}},jobs:{title:"Jobs",identifier:"Jobs",data:function(){var e="";switch(jobs.state.selectedProject.projectTypeId){case 1:e="Query Name";break;case 2:e="File Detail Name"}return{srcHeaderName:e,destHeaderName:"Salesforce Object"}},postLoad:function(e){parameterCtrl.datatable.loadDataTable({title:"Jobs",uri:function(){return"/api/operations/job/project/"+$("#selProjects").val()},identifier:"Jobs",columns:["id","name","type","srcSubDetailName","destSubDetailName"],customActionColumnRender:function(e,t,a,s){return'<span class="text-nowrap"><button class="btn btn-sm btn-icon me-2 edit-record" data-id="'+a.id+'"><i class="ti ti-edit"></i></button><button class="btn btn-sm btn-icon delete-record" data-id="'+a.id+'"><i class="ti ti-trash"></i></button></span>'},customColumnDefs:[{targets:3,searchable:!0,title:"Source Type",orderable:!0,render:function(e,t,a,s){var o="";switch(parseInt(a.source)){case 1:o='<span class="badge bg-label-info"><i class="ti ti-database"></i> DATABASE</span>';break;case 2:o='<span class="badge bg-label-warning"><i class="ti ti-file"></i> FILE SOURCE</span>'}return o}}],buttonFunc:function(){return[{text:"Add Job to Project",className:"add-new btn btn-primary mb-3 mb-md-0",init:function(e,t,a){$(t).removeClass("btn-secondary")},action:function(e,t,a,s){jobs.state.loadedJob=null,jobs.state.mapping=null,parameterCtrl.loadSectionWithCallbacks(jobs.genSections.upsertJobs),$(".sticky-element").sticky({topSpacing:$(".layout-navbar").height()+7,zIndex:9})}},{text:"Refresh",className:"add-new btn btn-warning mb-3 ms-1 mb-md-0",action:function(e,t,a,s){t.clear().draw(),t.ajax.reload()}}]}}),$("#dtJobs tbody").on("click",".edit-record",function(){var e=$(this).data("id");$.ajax({url:"/api/operations/job/"+e,type:"GET",contentType:"application/json",success:function(e){jobs.state.loadedJob=e,jobs.state.mapping=JSON.parse(JSON.stringify(e.mapping)),parameterCtrl.loadSectionWithCallbacks(jobs.genSections.upsertJobs),$(".sticky-element").sticky({topSpacing:$(".layout-navbar").height()+7,zIndex:9})}})})},postUnload:function(e){}},upsertJobs:{title:"UpsertJobs",identifier:"UpsertJobs",postLoad:function(e){switch(isAvail(jobs.state.loadedJob)&&$("#txtJobName").val(jobs.state.loadedJob.name),$("#btnResetMapping").attr("style","display: none !important;"),$("#btnResetMapping").click(function(){parameterCtrl.loadSectionWithCallbacks(jobs.genSections.mapping)}),$("#btnDiscardJob").click(function(){parameterCtrl.unloadSectionWithCallbacks(jobs.genSections.upsertJobs)}),$("#btnSaveJob").click(function(){let e="",a=!1;isAvail(jobs.state.mapping)&&jobs.state.mapping.forEach((e,t)=>{e=e.Value;e&&e.ExternalFlag&&(a=!0)}),$("#txtJobName").val().trim().length<=0&&(e+="Please provide Job Name.<br>"),a||(e+="Please provide External Id."),e?Swal.fire({title:"Notification",html:e,icon:"info",customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1}):Swal.fire({text:"Are you sure you would like to add this job?",icon:"warning",showCancelButton:!0,confirmButtonText:"Yes",customClass:{confirmButton:"btn btn-primary me-2",cancelButton:"btn btn-label-secondary"},buttonsStyling:!1}).then(function(e){var t,a,s,o;e.value&&(e={name:$("#txtJobName").val(),pId:$("#selProjects").val(),queryId:$("#selSourceDetails").val(),SObjectName:$("#selSfObjects").val(),mapping:jobs.state.mapping},t="POST",a="/api/operations/job",s="created",o="adding",isAvail(jobs.state.loadedJob)&&(t="PUT",s="updated",o="updating",e.id=jobs.state.loadedJob.id,a="/api/operations/job/"+e.id),e={name:$("#txtJobName").val(),pId:$("#selProjects").val(),srcSubDetailId:$("#selSourceDetails").val(),destSubDetailName:$("#selSfObjects").val(),mapping:jobs.state.mapping},$.ajax({url:a,type:t,contentType:"application/json",data:JSON.stringify(e),success:function(e){e.status?Swal.fire({title:"Success!",text:"Job has been "+s+"!",icon:"success",customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1}).then(()=>{parameterCtrl.unloadSectionWithCallbacks(jobs.genSections.upsertJobs),parameterCtrl.loadSectionWithCallbacks(jobs.genSections.jobs)}):Swal.fire({title:"Error!",text:"There was an error while "+o+" Job - "+e.errorMessage,icon:"error",customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1})},error:function(e){Swal.fire({title:"Error!",text:"There was an error while "+o+" Job",icon:"error",customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1})}}))})}),$("#btnStartMapping").click(function(){$("#selSourceDetails").val().length<=0?Swal.fire({title:"Notification",text:"Please select the database table to proceed.",icon:"info",customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1}):$("#selSfObjects").val().length<=0?Swal.fire({title:"Notification",text:"Please select the salesforce object to proceed.",icon:"info",customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1}):($("#btnStartMapping").attr("style","display: none !important;"),$("#btnResetMapping").removeAttr("style"),$("#selSourceDetails").prop("disabled",!0).trigger("change"),$("#selSfObjects").prop("disabled",!0).trigger("change"),parameterCtrl.loadSectionWithCallbacks(jobs.genSections.mapping),isAvail(jobs.state.loadedJob))}),jobs.state.selectedProject.projectTypeId){case 1:var t={uri:"/api/data/queryconfiguration/databaseconnection/"+jobs.state.selectedProject.sourceConnId,title:"Database Table",fields:[{selIdentifier:"#selSourceDetails",resKey:"id",resValue:"queryName",parentIdentifier:"#hbsInnersectionUpsertJobs .card-sourceDetails",changeEvent:function(){$.ajax({url:"/api/operations/source/datadetails",type:"POST",data:JSON.stringify({Id:$("#selSourceDetails").val(),SourceType:jobs.state.selectedProject.projectTypeId}),contentType:"application/json",success:function(e){if(e.error){var t="";switch(jobs.state.selectedProject.projectTypeId){case 1:t="Database Connection";break;case 2:t="File Source Connection"}Swal.fire({title:t+"Error!",text:"There was an error while fetching data for source - "+e.errorMessage,icon:"error",customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1})}else jobs.state.selectedSource=e}})}}]};parameterCtrl.selectAjax(t,function(e){isAvail(jobs.state.loadedJob)&&$("#selSourceDetails").val(jobs.state.loadedJob.srcSubDetailId).prop("disabled",!0).trigger("change")},function(e){var t="",t=e.error?e.errorMessage:"Data not available for sources";Swal.fire({title:"Error!",text:"There was an error while fetching data for sources - "+t,icon:"error",customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1}).then(()=>{parameterCtrl.unloadSectionWithCallbacks(jobs.genSections.upsertJobs)})});break;case 2:t={uri:"/api/data/filesourcedetail/filesourceconnection/"+jobs.state.selectedProject.sourceConnId,title:"File Source",fields:[{selIdentifier:"#selSourceDetails",resKey:"id",resValue:"fileSourceDetailName",parentIdentifier:"#hbsInnersectionUpsertJobs .card-sourceDetails",changeEvent:function(){$.ajax({url:"/api/operations/source/datadetails",type:"POST",data:JSON.stringify({Id:$("#selSourceDetails").val(),SourceType:jobs.state.selectedProject.projectTypeId}),contentType:"application/json",success:function(e){e.error?Swal.fire({title:"Error!",text:"There was an error while fetching data for selected source - "+e.errorMessage,icon:"error",customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1}):jobs.state.selectedSource=e}})}}]};parameterCtrl.selectAjax(t,function(e){isAvail(jobs.state.loadedJob)&&$("#selSourceDetails").val(jobs.state.loadedJob.srcSubDetailId).prop("disabled",!0).trigger("change")},function(e){var t="",t=e.error?e.errorMessage:"Data not available for sources";Swal.fire({title:"Error!",text:"There was an error while fetching data for sources - "+t,icon:"error",customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1}).then(()=>{parameterCtrl.unloadSectionWithCallbacks(jobs.genSections.upsertJobs)})})}var a={uri:"/api/SalesforceOps/getsfobjects/"+jobs.state.selectedProject.destConnId,title:"Salesforce Object",fields:[{selIdentifier:"#selSfObjects",resKey:"name",resValue:"name",parentIdentifier:"#hbsInnersectionUpsertJobs .card-sfobjects",changeEvent:function(){var e={salesforceConnectionId:jobs.state.selectedProject.destConnId,objectName:$("#selSfObjects").val()};$.ajax({url:"/api/SalesforceOps/getsfobjectdetails",type:"POST",contentType:"application/json",data:JSON.stringify(e),success:function(e){e.error?Swal.fire({title:"Error!",text:"There was an error while fetching data for destination - "+e.errorMessage,icon:"error",customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1}):jobs.state.selectedSfObject=e}})}}]};parameterCtrl.selectAjax(a,function(e){isAvail(jobs.state.loadedJob)&&$("#selSfObjects").val(jobs.state.loadedJob.destSubDetailName).prop("disabled",!0).trigger("change")},function(e){Swal.fire({title:"Token expired!",text:e.errorMessage,icon:"error",customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1}).then(()=>{parameterCtrl.unloadSectionWithCallbacks(jobs.genSections.upsertJobs)})})},data:function(){return{projectTypeId:jobs.state.selectedProject.projectTypeId,sfConnName:jobs.state.selectedProject.destConnName,sourceConnName:jobs.state.selectedProject.sourceConnName}},postUnload:function(e){}},mapping:{title:"Mapping",identifier:"Mapping",postLoad:function(e){if(isAvail(jobs.state.loadedJob)){for(var t=0;t<jobs.state.selectedSource.details.fields.length;t++){var a=jobs.state.loadedJob.mapping.find(e=>e.Key===jobs.state.selectedSource.details.fields[t].fieldId);isAvail(a)&&jobs.setMappingToExtraMappingSection(a.Value.Value,t,a)}jobs.state.mapping=JSON.parse(JSON.stringify(jobs.state.loadedJob.mapping))}else jobs.state.mapping=null;$("#floatingInput").on("keyup",function(){var e=$(this).val().toLowerCase();$(".list-group-item").each(function(){-1!==$(this).text().toLowerCase().indexOf(e)?$(this).show():$(this).hide()})}),$(".list-group-item").on("click",function(){jobs.setMappingToExtraMappingSection($(this).data("id"),jobs.state.selectedSfFieldIndex),$("#backDropModal").modal("hide")}),$(".btnSfDb").on("click",function(){jobs.state.selectedSfFieldIndex=$(this).data("buttonindex")})},data:function(){return{fields:jobs.state.selectedSource.details.fields,sfObjectData:jobs.state.selectedSfObject.data}},postUnload:function(e){}}},setMappingToExtraMappingSection:function(e,t,a){var s,o,n,i=e,r=jobs.state.selectedSource.details.fields[t].fieldId,e=(jobs.setMapping(t,"SFFIELD",!0,r,i),jobs.state.selectedSfObject.data.find(e=>e.id===i)),l=e.name;(e.isExternalId||e.isLookup)&&(s={index:t,isExternalId:e.isExternalId,isLookup:e.isLookup},o=document.getElementById("hbsExtraMappingDetail").innerHTML,o=Handlebars.compile(o),$(".hbsOutersectionExtraMappingDetail"+t).html(o(s)),e.isExternalId&&($(".chkbxExternalId"+t).change(function(){this.checked?jobs.setMapping(t,"EXTID",!0,r,i):jobs.setMapping(t,"EXTID",!1,r,i)}),isAvail(a))&&a.Value.ExternalFlag&&$(".chkbxExternalId"+t).prop("checked",!0).trigger("change"),e.isLookup)&&(n=e.lookupName,$(".chkbxLookup"+t).change(function(){this.checked?(StartPageLoader(),jobs.setLookupToSelect({descr:n,lookupName:n,selIdentifier:".selLookup"+t,resKey:"id",resValue:"name",parentIdentifier:".hbsOutersectionExtraMappingDetail"+t+" .card-body",changeEvent:function(){jobs.setMapping(t,"LOOKUP",!0,r,i,$(".selLookup"+t).val(),n)},successCb:function(e){isAvail(a)&&a.Value.LookupFlag&&$(".selLookup"+t).val(a.Value.LookupId).trigger("change")}})):($(".selLookup"+t).select2("destroy"),jobs.setMapping(t,"LOOKUP",!1,r,i))}),isAvail(a))&&a.Value.LookupFlag&&$(".chkbxLookup"+t).prop("checked",!0).trigger("change"),$(".sfField"+t).html(l)},customDestSection:{extraMapping:{title:"ExtraMapping",identifier:"ExtraMapping",isIteratable:!0,postLoad:function(){}}},getCustomSection:function(e,t){e=JSON.parse(JSON.stringify(jobs.customDestSection[e]));return e.parentIdentifier=t,e},lookups:{},setLookup:function(t,a){var e;isAvail(jobs.lookups[t])?a(null,jobs.lookups[t]):(e={salesforceConnectionId:jobs.state.selectedProject.destConnId,objectName:t},$.ajax({url:"/api/SalesforceOps/getsfobjectdetails",method:"POST",contentType:"application/json",data:JSON.stringify(e),success:function(e){jobs.lookups[t]=e,a(null,jobs.lookups[t])},error:function(e){a("Failed to fetch data",null)}}))},setLookupToSelect:function(o){jobs.setLookup(o.lookupName,function(e,t){var s;isAvail(e)?Swal.fire({title:"Error!",text:"There was an error loading lookup : "+e,icon:"error",customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1}):(Array.isArray(t.data)&&0<t.data.length&&(s=$(o.selIdentifier),t.data.forEach(function(t){var a;isFunction(o.title)?(a=$("<option/>",{value:t[o.resKey],title:o.title(t)}).text(t[o.resValue]),Array.isArray(o.attributes)&&0<o.attributes.length&&o.attributes.forEach(function(e){a.data(e.key,t[e.value])})):(a=$("<option/>",{value:t[o.resKey]}).text(t[o.resValue]),Array.isArray(o.attributes)&&0<o.attributes.length&&o.attributes.forEach(function(e){a.data(e.key,t[e.value])})),s.append(a)}),isFunction(o.changeEvent)&&s.on("change",o.changeEvent),isFunction(o.template)?s.select2({placeholder:"Select an "+o.descr,dropdownParent:$(o.parentIdentifier),templateResult:o.template,dropdownCssClass:"auto-height"}):s.select2({placeholder:"Select an "+o.descr,dropdownParent:$(o.parentIdentifier),dropdownCssClass:"auto-height"})),isFunction(o.successCb)&&o.successCb(t)),StopPageLoader()})}};function loadProjects(){parameterCtrl.loadSectionWithCallbacks(jobs.genSections.projects)}function loadJobs(){$(function(){parameterCtrl.loadSectionWithCallbacks(jobs.genSections.jobs),$(".datatables-jobs tbody").on("click",".delete-record",function(){dt_permission.row($(this).parents("tr")).remove().draw()})})}