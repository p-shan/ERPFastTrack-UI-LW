"use strict";$(document).ready(function(){loadProjects()});var schedules={state:{},setMapping:function(e,t,a,s,l,n,i){var d={ExternalFlag:!1,LookupFlag:!1,Value:"",LookupId:"",LookupName:""},c=-1;switch(isAvail(schedules.state.mapping)?(c=schedules.state.mapping.findIndex(e=>e.Key===s))<0?(schedules.state.mapping.push({Key:s,Value:d}),c=schedules.state.mapping.findIndex(e=>e.Key===s)):d=schedules.state.mapping[c].Value:(schedules.state.mapping=[],schedules.state.mapping.push({Key:s,Value:d}),c=schedules.state.mapping.findIndex(e=>e.Key===s)),t){case"SFFIELD":a?schedules.state.mapping[c].Value={ExternalFlag:!1,LookupFlag:!1,Value:l,LookupId:"",LookupName:""}:schedules.state.mapping.splice(c,1);break;case"EXTID":schedules.state.mapping[c].Value.ExternalFlag=!!a;break;case"LOOKUP":a?(schedules.state.mapping[c].Value.LookupFlag=!0,schedules.state.mapping[c].Value.LookupId=n,schedules.state.mapping[c].Value.LookupName=i):(schedules.state.mapping[c].Value.LookupFlag=!1,schedules.state.mapping[c].Value.LookupId="",schedules.state.mapping[c].Value.LookupName="")}},load:function(){},genSections:{projects:{title:"Projects",identifier:"Projects",postLoad:function(e){var t={title:function(e){return e.name},template:function(e){$(e.element).data("destinationTypeId");var t="";switch($(e.element).data("projectTypeId")){case 1:t="Database ➡️ Salesforce";return $(`<div>
                                      <h4 class="mb-1 d-flex align-items-center">                    
                                        <strong>${e.text}</strong> <small class="text-sm"> <span class="ms-2 badge bg-label-dark">${t}</span></small>
                                      </h4>
                                    </div>
                                    <small class="text-sm">
                                        <div class="mb-0 alert alert-primary d-flex align-items-center" role="alert">
                                        <span class="alert-icon text-primary me-2 p-2">
                                            <i class="fa-solid fa-database fa-fw"></i>
                                        </span>${$(e.element).data("sourceConnString")}
                                        </div>
                                        <div class="mt-1 mb-0 alert alert-info d-flex align-items-center" role="alert">
                                        <span class="alert-icon text-info me-2 p-2">
                                            <i class="fa-brands fa-salesforce fa-fw"></i>
                                        </span>${$(e.element).data("destConnUrl")}
                                        </div>
                                    </small>`);case 2:$(e.element).data("destinationTypeId");return t="File Source ➡️ Salesforce",$(`<div>
                                      <h4 class="mb-1 d-flex align-items-center">                    
                                        <strong>${e.text}</strong> <small class="text-sm"> <span class="ms-2 badge bg-label-dark">${t}</span></small>
                                      </h4>
                                    </div>
                                    <small class="text-sm">
                                        <div class="mb-0 alert alert-warning d-flex align-items-center" role="alert">
                                        <span class="alert-icon text-warning me-2 p-2">
                                            <i class="fa-solid fa-file fa-fw"></i>
                                        </span>${$(e.element).data("sourceConnString")}
                                        </div>
                                        <div class="mt-1 mb-0 alert alert-info d-flex align-items-center" role="alert">
                                        <span class="alert-icon text-info me-2 p-2">
                                            <i class="fa-brands fa-salesforce fa-fw"></i>
                                        </span>${$(e.element).data("destConnUrl")}
                                        </div>
                                    </small>`)}},attributes:[{key:"sourceConnString",value:"sourceConnString"},{key:"destConnUrl",value:"destConnUrl"},{key:"projectTypeId",value:"projectTypeId"},{key:"destinationTypeId",value:"destinationTypeId"}]};parameterCtrl.selectAjax({uri:"/api/operations/project",title:"Project",fields:[{selIdentifier:"#selProjects",resKey:"id",resValue:"name",parentIdentifier:"#hbsInnersectionProjects .card-body",title:t.title,attributes:t.attributes,template:t.template}]},function(e){$("#btnClearJobs").click(function(){parameterCtrl.unloadSectionWithCallbacks(schedules.genSections.schedules),parameterCtrl.unloadSectionWithCallbacks(schedules.genSections.schedulingDetails),$("#selProjects").prop("disabled",!1).trigger("change"),$("#selProjects").val("").trigger("change"),$("#btnLoadSchedules").prop("disabled",!1)}),$("#btnLoadSchedules").click(function(){0<$("#selProjects").val().length?$.ajax({url:"/api/operations/project/"+$("#selProjects").val(),type:"GET",contentType:"application/json",success:function(e){schedules.state.selectedProject=e,parameterCtrl.unloadSectionWithCallbacks(schedules.genSections.schedules),parameterCtrl.unloadSectionWithCallbacks(schedules.genSections.schedulingDetails),loadSchedules(),$("#selProjects").prop("disabled",!0).trigger("change"),$("#btnLoadSchedules").prop("disabled",!0);e={title:function(e){return e.name},attributes:[{key:"jobName",value:"name"},{key:"jobId",value:"id"},{key:"sourceName",value:"srcSubDetailName"},{key:"destName",value:"destSubDetailName"}]},e={uri:"/api/operations/job/project/"+$("#selProjects").val(),title:"Jobs",fields:[{selIdentifier:"#selJobs",resKey:"id",resValue:"name",parentIdentifier:"#mdlAddJobSchedule .modal-body",title:e.title,attributes:e.attributes}]};parameterCtrl.selectAjax(e)}}):Swal.fire({title:"Notification",text:"Please select the project to proceed.",icon:"info",customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1})})})},postUnload:function(e){}},schedules:{title:"Schedules",identifier:"Schedules",postLoad:function(e){parameterCtrl.datatable.loadDataTable({title:"Schedules",deleteUri:function(){return"/api/operations/scheduling"},uri:function(){return"/api/operations/scheduling/project/"+$("#selProjects").val()},identifier:"Schedules",columns:["id","name","jobs","scheduleType","isActive","status"],customRowCallback:function(e,t,a){$(e).find("td:eq(2)").addClass("bg-label-primary")},customColumnDefs:[{targets:3,searchable:!0,title:"Jobs",orderable:!1,render:function(e,t,a,s){var l;return isAvail(a)&&isAvail(a.jobDetails)&&0<a.jobDetails.length?(l=document.getElementById("hbsJobTags").innerHTML,Handlebars.compile(l)(a.jobDetails)):""}},{targets:4,searchable:!0,title:"Schedule Type",orderable:!0,render:function(e,t,a,s){var l="",n="",i="";return 1==a.scheduleType?(l='<span class="avatar-initial rounded-circle bg-default">I</span>',n="Immediately"):2==a.scheduleType?(l='<span class="avatar-initial rounded-circle bg-warning">H</span>',n="Hourly",i='<small class="emp_post text-truncate text-muted">Total Executions : '+a.noOfExecutions+"</small>"):3==a.scheduleType?(l='<span class="avatar-initial rounded-circle bg-primary">D</span>',n="Daily",i='<small class="emp_post text-truncate text-muted">Total Executions : '+a.noOfExecutions+"</small>"):4==a.scheduleType&&(l='<span class="avatar-initial rounded-circle bg-info">M</span>',n="Monthly",i='<small class="emp_post text-truncate text-muted">Total Executions : '+a.noOfExecutions+"</small>"),'<div class="d-flex justify-content-start align-items-center user-name"><div class="avatar-wrapper"><div class="avatar me-2">'+l+'</div></div><div class="d-flex flex-column"><span class="emp_name text-truncate">'+n+"</span>"+i+"</div></div>"}},{targets:5,searchable:!0,title:"Active",orderable:!0,render:function(e,t,a,s){var l='<span class="badge  bg-label-success"><i class="ti ti-check"></i> Yes</span>';return l=a.isActive?l:'<span class="badge  bg-label-secondary"><i class="ti ti-x"></i> No</span>'}},{targets:6,searchable:!0,title:"Execution Status",orderable:!0,render:function(e,t,a,s){return 1!==a.executionStatus?"":"<span class='badge bg-warning'><i class='ti ti-calendar-time'></i> Scheduled</span>"}}],customActionColumnRender:function(e,t,a,s){return'<span class="text-nowrap"><button class="btn btn-sm btn-icon me-2 edit-record" data-id="'+a.id+'"><i class="ti ti-edit"></i></button><button class="btn btn-sm btn-icon delete-record" data-id="'+a.id+'"><i class="ti ti-trash"></i></button></span>'},buttonFunc:function(){return[{text:"Add Schedule to Project",className:"add-new btn btn-primary mb-3 mb-md-0",init:function(e,t,a){$(t).removeClass("btn-secondary")},action:function(e,t,a,s){schedules.state.loadedSchedule=null,parameterCtrl.loadSectionWithCallbacks(schedules.genSections.schedulingDetails),$(".sticky-element").sticky({topSpacing:$(".layout-navbar").height()+7,zIndex:9});var l=document.getElementById("sortable-4");Sortable.create(l,{animation:500,handle:".card"})}},{text:"Refresh",className:"add-new btn btn-warning mb-3 ms-1 mb-md-0",action:function(e,t,a,s){t.clear().draw(),t.ajax.reload()}}]}}),$("#dtSchedules tbody").on("click",".edit-record",function(){var e=$(this).data("id");$.ajax({url:"/api/operations/scheduling/"+e,type:"GET",contentType:"application/json",success:function(e){schedules.state.loadedSchedule=e,parameterCtrl.loadSectionWithCallbacks(schedules.genSections.schedulingDetails),$(".sticky-element").sticky({topSpacing:$(".layout-navbar").height()+7,zIndex:9});e=document.getElementById("sortable-4");Sortable.create(e,{animation:500,handle:".card"})}})})},postUnload:function(e){}},schedulingDetails:{title:"SchedulingDetails",identifier:"SchedulingDetails",postLoad:function(e){$([document.documentElement,document.body]).animate({scrollTop:$("#hbsOutersectionSchedulingDetails").offset().top},100),schedules.state.addedJobs=[],$("#divHourlyMinute, #divMonthlyDay, #divMonthlyTime, #divDaily, #divEndDate, #divStartDate, #divScheduleExtraDivider").hide(),isAvail(schedules.state.loadedSchedule)&&($("#txtScheduleName").val(schedules.state.loadedSchedule.name),$("#selScheduleType").val(schedules.state.loadedSchedule.scheduleType).trigger("change"),$("#txtStartDate").val(ExtractDate(schedules.state.loadedSchedule.startDate)),$("#txtEndDate").val(ExtractDate(schedules.state.loadedSchedule.endDate)),$("#selHourlyMinute").val(schedules.state.loadedSchedule.hourlyMinutes).trigger("change"),$("#selMonthDay").val(schedules.state.loadedSchedule.monthDay).trigger("change"),$("#txtMonthTime").val(schedules.state.loadedSchedule.monthTime),$("#txtDailyTime").val(schedules.state.loadedSchedule.dailyTime),$("#chkbxIsActive").prop("checked",schedules.state.loadedSchedule.isActive).trigger("change"),schedules.state.loadedSchedule.jobDetails.forEach(function(e){var t=e.name,a=e.id,s=e.sourceName,e=e.destName,a={Index:schedules.state.addedJobs.length,Id:a,JobName:t,ProjectTypeId:schedules.state.selectedProject.projectTypeId,DestinationTypeId:schedules.state.selectedProject.destinationTypeId,SourceName:s,DestName:e},s=document.getElementById("hbsJobDetail").innerHTML,e=Handlebars.compile(s);$("#sortable-4").append(e(a)),schedules.state.addedJobs.push(t)})),$("#btnLoadJobs").click(function(){$("#selJobs").val("").trigger("change")}),$("#selScheduleType").select2({placeholder:"Select an Schedule Type",dropdownParent:$("#schedulingDetails .card-body")}),$("#selMonthDay").select2({placeholder:"Select Month Day",dropdownParent:$("#schedulingDetails .card-body")}),$("#selHourlyMinute").select2({placeholder:"Select Day Time",dropdownParent:$("#schedulingDetails .card-body")}),$("#cronExpression").hide(),$("#selScheduleType").on("select2:select",function(e){$("#divHourlyMinute, #divMonthlyDay, #divMonthlyTime, #divDaily, #divEndDate, #divStartDate, #divScheduleExtraDivider").hide(),2==$("#selScheduleType").val()?$("#divHourlyMinute, #divEndDate, #divStartDate, #divScheduleExtraDivider").show():3==$("#selScheduleType").val()?$("#divDaily, #divEndDate, #divStartDate, #divScheduleExtraDivider").show():4==$("#selScheduleType").val()&&$("#divMonthlyTime, #divMonthlyDay, #divEndDate, #divStartDate, #divScheduleExtraDivider").show()}),isAvail(schedules.state.loadedSchedule)&&$("#selScheduleType").trigger("select2:select"),$("#frmAddJobSchedule").off("submit"),$("#frmAddJobSchedule").submit(function(e){e.preventDefault();var e=$("#selJobs option:selected"),t=e.data("jobName"),a=e.data("jobId"),s=e.data("destName"),e=e.data("sourceName");isAvail(t)?schedules.state.addedJobs.includes(t)?Swal.fire({title:"Error!",text:"This job was already added to this schedule!",icon:"error",customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1}):(a={Index:schedules.state.addedJobs.length,Id:a,JobName:t,ProjectTypeId:schedules.state.selectedProject.projectTypeId,SourceName:e,DestName:s},e=document.getElementById("hbsJobDetail").innerHTML,s=Handlebars.compile(e),$("#sortable-4").append(s(a)),schedules.state.addedJobs.push(t),$("#mdlAddJobSchedule").modal("hide"),$("#frmAddJobSchedule")[0].reset()):Swal.fire({title:"Error!",text:"Please select job to add in this schedule!",icon:"error",customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1})}),isAvail(schedules.state.loadedSchedule)&&$("#txtScheduleName").val(schedules.state.loadedSchedule.name),$("#btnDiscardSchedule").click(function(){parameterCtrl.unloadSectionWithCallbacks(schedules.genSections.schedulingDetails)}),$("#btnSaveSchedule").click(function(){let e="";var t,a,s,l={name:$("#txtScheduleName").val(),pId:$("#selProjects").val(),scheduleType:$("#selScheduleType").val(),jobIds:[],startDate:$("#txtStartDate").val(),endDate:$("#txtEndDate").val(),hourlyMinutes:$("#selHourlyMinute").val(),monthDay:$("#selMonthDay").val(),monthTime:$("#txtMonthTime").val(),dailyTime:$("#txtDailyTime").val(),isActive:$("#chkbxIsActive").prop("checked")},n=($("#txtScheduleName").val().trim().length<=0&&(e+="Please provide Schedule Name.<br>"),$(".divJobDetails"));isAvail(n)&&0<n.length?n.each(function(e,t){l.jobIds.push($(t).data("jobid"))}):e+="Please add jobs in the schedule.",e?Swal.fire({title:"Notification",html:e,icon:"info",customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1}):(n="POST",t="/api/operations/scheduling",a="created",s="adding",isAvail(schedules.state.loadedSchedule)&&(n="PUT",a="updated",s="updating",l.id=schedules.state.loadedSchedule.id,t="/api/operations/scheduling/"+l.id),$.ajax({url:t,type:n,contentType:"application/json",data:JSON.stringify(l),success:function(e){e.status?Swal.fire({title:"Success!",text:"Schedule has been "+a+"!",icon:"success",customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1}).then(()=>{parameterCtrl.unloadSectionWithCallbacks(schedules.genSections.schedulingDetails),parameterCtrl.loadSectionWithCallbacks(schedules.genSections.schedules)}):Swal.fire({title:"Error!",text:"There was an error while "+s+" Schedule - "+e.errorMessage,icon:"error",customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1})},error:function(e){Swal.fire({title:"Error!",text:"There was an error while "+s+" Schedule",icon:"error",customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1})}}))})},data:function(){return{sfConnName:schedules.state.selectedProject.salesforceConnName,dbConnName:schedules.state.selectedProject.databaseConnName}},postUnload:function(e){}}},customDestSection:{jobDetail:{title:"JobDetail",identifier:"JobDetail",isIteratable:!0,postLoad:function(){}}},getCustomSection:function(e,t){e=JSON.parse(JSON.stringify(jobs.customDestSection[e]));return e.parentIdentifier=t,e}};function loadProjects(){parameterCtrl.loadSectionWithCallbacks(schedules.genSections.projects)}function loadSchedules(){$(function(){parameterCtrl.loadSectionWithCallbacks(schedules.genSections.schedules)})}function deleteJob(e){var e=e.closest(".divJobDetail"),t=e.querySelector(".card-title").textContent.trim(),t=schedules.state.addedJobs.indexOf(t);-1!==t&&schedules.state.addedJobs.splice(t,1),e.remove()}