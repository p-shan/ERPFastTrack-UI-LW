"use strict";$(document).ready(function(){loadExecutions()});var executions={state:{},load:function(){},charts:{leadsChart:function(e,t,o,a){let n,s,i;i=(isDarkStyle?(n=config.colors_dark.textMuted,s=config.colors_dark.headingColor,config.colors_dark):(n=config.colors.textMuted,s=config.colors.headingColor,config.colors)).borderColor;var c=document.querySelector("#leadsReportChart"),e={chart:{height:157,width:130,parentHeightOffset:0,type:"donut"},labels:e,series:t,colors:o,stroke:{width:0},dataLabels:{enabled:!1,formatter:function(e,t){return parseInt(e)+"%"}},legend:{show:!1},tooltip:{theme:!1},grid:{padding:{top:0}},plotOptions:{pie:{donut:{size:"75%",labels:{show:!0,value:{fontSize:"1.5rem",fontFamily:"Public Sans",color:s,fontWeight:500,offsetY:-15,formatter:function(e){return parseInt(e)+"%"}},name:{offsetY:20,fontFamily:"Public Sans"},total:{show:!0,fontSize:".7rem",label:"Total",color:n,formatter:function(e){return a}}}}}}};null!==c&&new ApexCharts(c,e).render()},doughnutChart:function(e,t){let o,a,n,s,i;s=(isDarkStyle?(o=config.colors_dark.cardColor,a=config.colors_dark.headingColor,n=config.colors_dark.textMuted,i=config.colors_dark.bodyColor,config.colors_dark):(o=config.colors.cardColor,a=config.colors.headingColor,n=config.colors.textMuted,i=config.colors.bodyColor,config.colors)).borderColor;document.querySelectorAll(".chartjs").forEach(function(e){e.height=e.dataset.height});t=document.getElementById("doughnutChart"+t);t&&new Chart(t,{type:"doughnut",data:{labels:["Processed","Failed"],datasets:[{data:e,backgroundColor:[config.colors.success,config.colors.danger],borderWidth:0,pointStyle:"rectRounded"}]},options:{responsive:!0,animation:{duration:500},cutout:"68%",plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(e){return" "+(e.labels||"")+" : "+e.parsed+" records"}},rtl:isRtl,backgroundColor:o,titleColor:a,bodyColor:i,borderWidth:1,borderColor:s}}}})}},genSections:{executions:{title:"Executions",identifier:"Executions",postLoad:function(e){parameterCtrl.datatable.loadDataTable({title:"Executions",uri:function(){return"/api/operations/execution"},identifier:"Executions",columns:["id","scheduleName","numberOfJobs","status","scheduledAt"],customColumnDefs:[{targets:4,searchable:!0,title:"Status",orderable:!0,render:function(e,t,o,a){switch(o.executionStatus){case 1:return'<span class="badge bg-label-secondary">SCHEDULED</span>';case 2:return'<span class="badge  bg-label-info">IN-PROGRESS</span>';case 3:return'<span class="badge  bg-label-success">COMPLETED</span>';case 4:return'<span class="badge  bg-label-danger">FAILED</span>'}}},{targets:5,searchable:!0,title:"Scheduled at",orderable:!0,render:function(e,t,o,a){return moment(o.scheduledAt).format("lll")}}],customActionColumnRender:function(e,t,o,a){return'<span class="text-nowrap"><button class="btn btn-sm btn-icon me-2 view-record"  data-status="'+o.executionStatus+'" data-id="'+o.id+'"><i class="ti ti-eye"></i></button>'},buttonFunc:function(){return[{text:"Refresh",className:"add-new btn btn-warning mb-3 ms-1 mb-md-0",action:function(e,t,o,a){t.clear().draw(),t.ajax.reload()}}]}}),$("#dtExecutions tbody").on("click",".view-record",function(){var t=$(this).data("status"),e=$(this).data("id");3==t||4==t?$.ajax({url:"/api/operations/execution/"+e,type:"GET",contentType:"application/json",success:function(e){executions.state.loadedExecution=e,parameterCtrl.unloadSectionWithCallbacks(executions.genSections.executionDetails),4==t?Swal.fire({title:"Error!",text:"There was an error while running the execution - "+e.failedReason,icon:"error",customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1}):parameterCtrl.loadSectionWithCallbacks(executions.genSections.executionDetails)}}):toastr.warning("Job is not completed")})},postUnload:function(e){}},executionDetsTable:{title:"ExecutionDetsTable",identifier:"ExecutionDetsTable",postLoad:function(e){StartPageLoader();var t=executions.state.ExecutionDetailId;parameterCtrl.datatable.loadDataTable({title:"ExecutionDets",uri:function(){return"/api/operations/execution/details/"+t},identifier:"ExecutionDets",columns:["id","salesforceId","externalIdName","status","message","messageCode"],customColumnDefs:[{targets:3,searchable:!0,title:"Details",orderable:!1,render:function(e,t,o,a){return isAvail(o)&&isAvail(o.externalIdName)&&isAvail(o.externalIdValue)?'<div class="d-flex justify-content-start align-items-center user-name"><div class="d-flex flex-column"><span class="text-truncate">External Id</span><small class="text-truncate text-muted">'+o.externalIdName+": "+o.externalIdValue+"</small></div></div>":""}},{targets:4,searchable:!0,title:"Status",orderable:!0,render:function(e,t,o,a){var n="true"!=o.schemaFailure&&"true"==o.created,s=n?'<i class="ti ti-checks ti-sm"/>':'<i class="ti ti-x ti-sm"/>',i="true"!=o.schemaFailure?"Success":"Failed",c="true"==o.created?"Created":"Error";return isAvail(o)&&isAvail(o.created)&&isAvail(o.schemaFailure)?'<span data-bs-toggle="tooltip" data-bs-html="true" aria-label="<span><strong>Status</strong><br> <span class=&quot;fw-medium fw-medium&quot;>Created:</span> '+c+"<br> <span class=&quot;fw-medium fw-medium&quot;>Schema:</span> "+i+'</span>" data-bs-original-title="<span><strong>Status</strong><br> <span class=&quot;fw-medium fw-medium&quot;>Created:</span> '+c+"<br> <span class=&quot;fw-medium fw-medium&quot;>Schema:</span> "+i+'</span>"><span class="badge badge-center rounded-pill bg-label-'+(n?"success":"danger")+' w-px-30 h-px-30">'+s+"</span></span>":""}}],customRowCallback:function(e,t,o){$($(e).find("td:eq(3)").find('span[data-bs-toggle="tooltip"]')[0]).tooltip()},buttonFunc:function(){return null},customActionColumnRender:function(e,t,o,a){return'<span class="text-nowrap"><button class="btn btn-sm btn-icon me-2 view-record" data-id="'+o.id+'"><i class="ti ti-eye"></i></button>'},completeFunc:function(){$("#hbsOutersectionExecutionDetsRecord").html(""),$("#exLargeModal").modal("show"),StopPageLoader()}}),$("#dtExecutionDets tbody").on("click",".view-record",function(){var e=$(this).data("id");$.ajax({url:"/api/operations/execution/details/history/"+e,type:"GET",contentType:"application/json",success:function(e){executions.state.loadedExecutionHistory=e,parameterCtrl.loadSectionWithCallbacks(executions.genSections.executionDetsRecord)}})})}},executionDetsRecord:{title:"ExecutionDetsRecord",identifier:"ExecutionDetsRecord",postLoad:function(e){$("#json-request").jsonViewer(JSON.parse(executions.state.loadedExecutionHistory.jsonReq)),$("#json-response").jsonViewer(JSON.parse(executions.state.loadedExecutionHistory.jsonRes)),$("#exLargeModal .modal-body").animate({scrollTop:$("#exLargeModal .modal-body").prop("scrollHeight")},"slow")},data:function(){return{jsonReq:executions.state.loadedExecutionHistory.jsonReq,jsonRes:executions.state.loadedExecutionHistory.jsonRes}},postUnload:function(e){}},executionDetails:{title:"ExecutionDets",identifier:"ExecutionDets",postLoad:function(e){if($([document.documentElement,document.body]).animate({scrollTop:$("#hbsOutersectionExecutionDets").offset().top},100),isAvail(executions.state.loadedExecution)){var t=(new Date(executions.state.loadedExecution.completionTime)-new Date(executions.state.loadedExecution.startTime))/1e3;let o=moment(executions.state.loadedExecution.scheduledAt).format("lll");var e={ScheduleName:executions.state.loadedExecution.scheduleName,ScheduleStatus:executions.state.loadedExecution.executionStatus,ScheduledAt:o,NumberOfJobs:executions.state.loadedExecution.numberOfJobs,SuccessfulJobs:executions.state.loadedExecution.successfulJobs,FailedJobs:executions.state.loadedExecution.failedJobs,TimeSpending:t},a=document.getElementById("hbsExecutionDets").innerHTML,n=Handlebars.compile(a),s=($("#ExecutionCardDetail").html(n(e)),[]),i=[],c=[],r=[],e=t+"s",l=["#ccff33","#9ef01a","#70e000","#38b000","#008000","#007200","#006400","#004b23"],d=["#fc9ca2","#fb747d","#fa4c58","#f92432","#e30613","#c70512","#9f040e","#77030b"],u=0,m=0,a=(executions.state.loadedExecution.jobDetails.forEach(function(e,t){c.push(e.name),i.push((new Date(e.completionTime)-new Date(e.startTime))/1e3),e.status?r.push(l[u++]):r.push(d[m++]);t={Initial:e.name[0],Index:t,ExecutionDetailId:e.id,JobName:e.name,JobStatus:e.status?"Completed":"Failed",JobCreatedTime:o,JobStartTime:moment(e.startTime).format("lll"),JobCompletionTime:moment(e.completionTime).format("lll"),JobObservations:e.observations,JobProcessedRecords:e.processedRecords,JobFailedRecords:e.failedRecords,JobTotalRecords:e.totalRecords,SuccessPercent:Math.round(e.processedRecords/e.totalRecords*100),FailurePercent:Math.round(e.failedRecords/e.totalRecords*100),ExternalId:e.externalId,SourceName:e.sourceName,ProjectTypeId:e.projectType,DestinationTypeId:e.destinationType,SourceDetName:e.sourceDetName,DestName:e.destName,DestDetName:e.destDetName};s.push(t)}),document.getElementById("hbsExecutionJobDetails").innerHTML),n=Handlebars.compile(a);$("#divJobDetails").html(n(s)),executions.state.loadedExecution.jobDetails.forEach(function(e,t){e=[e.processedRecords,e.failedRecords];executions.charts.doughnutChart(e,t)}),executions.charts.leadsChart(c,i,r,e),$(".btnExploreDets").on("click",function(){executions.state.ExecutionDetailId=$(this).data("executiondetailid"),parameterCtrl.loadSectionWithCallbacks(executions.genSections.executionDetsTable),$("#detTitle").html($(this).data("jobname"))}),$(".btnExtDtModalClose").click(function(){$("#exLargeModal").modal("hide")})}},data:function(){},postUnload:function(e){}}}};function loadExecutions(){parameterCtrl.loadSectionWithCallbacks(executions.genSections.executions)}